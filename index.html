<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Housing Data Central</title>

  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { margin: 0 0 6px; }
    .sub { color: #555; margin: 0 0 18px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 14px 0; }
    canvas { max-width: 100%; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    th { background: #fafafa; position: sticky; top: 0; }
    .note { color: #666; font-size: 13px; margin-top: 8px; }
    .error { color: #b00020; white-space: pre-wrap; }
    .ok { color: #1a7f37; }
  </style>
</head>

<body>
  <h1>Housing Affordability Monitor</h1>
  <p class="sub">
    Median household income as a % of median existing-home price (monthly).
    Bars > 35% are red; ≤ 35% are blue.
  </p>

  <div class="card" style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
    <div style="min-width:260px;">
      <div style="font-size:13px; color:#666;">Latest affordability</div>
      <div id="kpiValue" style="font-size:34px; font-weight:700; line-height:1.05;">--</div>
      <div id="kpiMeta" style="font-size:13px; color:#666; margin-top:4px;">--</div>
    </div>

    <div style="flex:1; min-width:260px;">
      <div id="status">Loading data...</div>
      <div id="err" class="error"></div>

      <div style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="color:#555; font-size:13px;">View:</div>
        <button id="btn10" class="btn">Last 10 years</button>
        <button id="btn20" class="btn btnActive">Last 20 years</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Affordability over time</h2>
    <canvas id="chart" height="120"></canvas>
    <div class="note">
      Income: MEHOINUSA672N (annual, forward-filled). Price: HOSMEDUSM052N (monthly existing-home median price).
      35% reference line shown.
    </div>
  </div>

  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { margin: 0 0 6px; }
    .sub { color: #555; margin: 0 0 18px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 14px 0; }
    .note { color: #666; font-size: 13px; margin-top: 8px; }
    .error { color: #b00020; white-space: pre-wrap; margin-top: 6px; }
    .ok { color: #1a7f37; }

    .btn {
      border: 1px solid #ccc;
      background: #fff;
      padding: 7px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }
    .btnActive {
      border-color: #555;
      font-weight: 700;
    }
  </style>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const FRED_PROXY_URL = "https://fred-proxy.patrick-grow.workers.dev";

    const INCOME_SERIES = "MEHOINUSA672N";   // annual
    const PRICE_SERIES  = "HOSMEDUSM052N";   // monthly (existing-home median price)
    const THRESHOLD = 35;                    // percent

    let chart;
    let affordabilityAll = [];               // full monthly history (as available)
    let currentWindowYears = 20;             // toggle state

    // ==========================
    // Helpers
    // ==========================
    const fmtPct1 = new Intl.NumberFormat("en-US", { maximumFractionDigits: 1, minimumFractionDigits: 1 });
    const fmtMonth = new Intl.DateTimeFormat("en-US", { year: "numeric", month: "short" });

    function parseFredValue(v) {
      if (v === "." || v === null || v === undefined) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    async function fetchSeries(seriesId) {
      const url = new URL(FRED_PROXY_URL);
      url.searchParams.set("series_id", seriesId);
      url.searchParams.set("file_type", "json");

      const resp = await fetch(url.toString());
      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error("Request failed (" + resp.status + ")\n" + txt);
      }

      const data = await resp.json();
      if (!data || !Array.isArray(data.observations)) {
        throw new Error("Unexpected response shape for " + seriesId);
      }

      return data.observations
        .map(o => ({
          date: new Date(o.date + "T00:00:00"),
          value: parseFredValue(o.value)
        }))
        .filter(o => o.value !== null)
        .sort((a, b) => a.date - b.date);
    }

    function addYears(d, years) {
      const x = new Date(d);
      x.setFullYear(x.getFullYear() + years);
      return x;
    }

    function monthStart(d) {
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }

    function sliceLastYears(data, yearsBack) {
      if (!data.length) return [];
      const latest = data[data.length - 1].date;
      const start = monthStart(addYears(latest, -yearsBack));
      return data.filter(o => o.date >= start);
    }

    // Build the monthly timeline from the monthly price series
    function toMonthlyTimeline(priceObsRaw) {
      return priceObsRaw.map(o => ({ date: monthStart(o.date), value: o.value }));
    }

    // Forward-fill annual income to the monthly timeline
    function forwardFillIncomeToMonths(incomeObs, monthlyDates) {
      const incomeByYear = new Map(incomeObs.map(o => [o.date.getFullYear(), o.value]));
      const years = Array.from(incomeByYear.keys()).sort((a, b) => a - b);

      function latestIncomeForYear(y) {
        for (let i = years.length - 1; i >= 0; i--) {
          if (years[i] <= y) return incomeByYear.get(years[i]);
        }
        return null;
      }

      return monthlyDates.map(d => ({
        date: d,
        value: latestIncomeForYear(d.getFullYear())
      }));
    }

    function buildAffordability(incomeMonthly, priceMonthly) {
      const priceByTime = new Map(priceMonthly.map(p => [p.date.getTime(), p.value]));
      const out = [];

      for (const inc of incomeMonthly) {
        const p = priceByTime.get(inc.date.getTime());
        if (inc.value == null || p == null) continue;
        out.push({ date: inc.date, ratio: (inc.value / p) * 100 });
      }

      out.sort((a, b) => a.date - b.date);
      return out;
    }

    // ==========================
    // KPI tile
    // ==========================
    function renderKpi(latestPoint) {
      const kpiValue = document.getElementById("kpiValue");
      const kpiMeta = document.getElementById("kpiMeta");

      const v = latestPoint.ratio;
      const above = v > THRESHOLD;

      kpiValue.textContent = fmtPct1.format(v) + "%";
      kpiValue.style.color = above ? "#b00020" : "#1a7f37";

      kpiMeta.textContent =
        fmtMonth.format(latestPoint.date) +
        " • " + (above ? "Above" : "At/Below") + " 35% threshold";
    }

    // ==========================
    // 35% reference line plugin
    // ==========================
    const thresholdLinePlugin = {
      id: "thresholdLine",
      afterDraw(chartInstance, args, opts) {
        const y = (opts && typeof opts.yValue === "number") ? opts.yValue : null;
        if (y === null) return;

        const { ctx, chartArea, scales } = chartInstance;
        if (!chartArea) return;

        const yScale = scales.y;
        const yPix = yScale.getPixelForValue(y);

        if (yPix < chartArea.top || yPix > chartArea.bottom) return;

        ctx.save();
        ctx.strokeStyle = "rgba(0,0,0,0.45)";
        ctx.lineWidth = 1;
        ctx.setLineDash([6, 4]);

        ctx.beginPath();
        ctx.moveTo(chartArea.left, yPix);
        ctx.lineTo(chartArea.right, yPix);
        ctx.stroke();

        // Label
        ctx.setLineDash([]);
        ctx.fillStyle = "rgba(0,0,0,0.65)";
        ctx.font = "12px Arial";
        ctx.fillText("35% threshold", chartArea.left + 6, yPix - 6);

        ctx.restore();
      }
    };

    // ==========================
    // Chart render
    // ==========================
    function renderChart(series) {
      const labels = series.map(d => fmtMonth.format(d.date));
      const values = series.map(d => d.ratio);
      const colors = series.map(d => (d.ratio > THRESHOLD ? "#d32f2f" : "#1976d2"));

      const ctx = document.getElementById("chart");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Income / Existing-Home Price (%)",
            data: values,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (ctx) => " " + fmtPct1.format(ctx.raw) + "%"
              }
            },
            thresholdLine: { yValue: THRESHOLD }
          },
          scales: {
            x: { ticks: { maxTicksLimit: 12 } },
            y: {
              beginAtZero: true,
              ticks: { callback: (v) => fmtPct1.format(v) + "%" }
            }
          }
        },
        plugins: [thresholdLinePlugin]
      });
    }

    // ==========================
    // Toggle handling
    // ==========================
    function setWindowYears(years) {
      currentWindowYears = years;

      document.getElementById("btn10").classList.toggle("btnActive", years === 10);
      document.getElementById("btn20").classList.toggle("btnActive", years === 20);

      const sliced = sliceLastYears(affordabilityAll, currentWindowYears);
      renderChart(sliced);
    }

    // ==========================
    // Main
    // ==========================
    (async function main() {
      const status = document.getElementById("status");
      const err = document.getElementById("err");

      try {
        status.textContent = "Fetching FRED series...";
        err.textContent = "";

        const [incomeObs, priceObsRaw] = await Promise.all([
          fetchSeries(INCOME_SERIES),
          fetchSeries(PRICE_SERIES)
        ]);

        const priceMonthly = toMonthlyTimeline(priceObsRaw);
        if (priceMonthly.length === 0) throw new Error("Price series returned no monthly observations.");

        const monthlyDates = priceMonthly.map(p => p.date);
        const incomeMonthly = forwardFillIncomeToMonths(incomeObs, monthlyDates);

        affordabilityAll = buildAffordability(incomeMonthly, priceMonthly);
        if (affordabilityAll.length === 0) throw new Error("No overlapping data points after alignment.");

        const latest = affordabilityAll[affordabilityAll.length - 1];

        status.innerHTML =
          "<span class='ok'>Loaded</span> " +
          affordabilityAll.length + " months. Latest: " +
          fmtMonth.format(latest.date) + " = " + fmtPct1.format(latest.ratio) + "%.";

        renderKpi(latest);

        // initial render = 20y
        setWindowYears(20);

        // wire up buttons
        document.getElementById("btn10").addEventListener("click", () => setWindowYears(10));
        document.getElementById("btn20").addEventListener("click", () => setWindowYears(20));

      } catch (e) {
        status.textContent = "Could not load data.";
        err.textContent = String(e && e.message ? e.message : e);
        console.error(e);
      }
    })();
  </script>
</body>
</html>
