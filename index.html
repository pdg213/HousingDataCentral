<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Housing Data Central</title>

  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { margin: 0 0 6px; }
    .sub { color: #555; margin: 0 0 18px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 14px 0; }
    canvas { max-width: 100%; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    th { background: #fafafa; position: sticky; top: 0; }
    .note { color: #666; font-size: 13px; margin-top: 8px; }
    .error { color: #b00020; white-space: pre-wrap; }
    .ok { color: #1a7f37; }
  </style>
</head>

<body>
  <h1>New One Family Houses Sold (HSN1F)</h1>
  <p class="sub">
    Source: FRED (U.S. Census Bureau / HUD). Units: Thousands, Seasonally Adjusted Annual Rate.
  </p>

  <div class="card">
    <div id="status">Loading data...</div>
    <div id="err" class="error"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Last 20 years (line chart)</h2>
    <canvas id="chart" height="110"></canvas>
    <div class="note">Chart shows the last 20 years ending at the latest available observation.</div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Most recent 18 months (table)</h2>
    <div style="overflow:auto; max-height: 520px;">
      <table>
        <thead>
          <tr>
            <th>Month reported</th>
            <th>Raw data number</th>
            <th>% change y/y</th>
            <th>% change q/q</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="note">
      q/q definition: average of last 3 months vs average of prior 3 months (percent change).
    </div>
  </div>

<script>
  // 1) CONFIG: paste your key
  const FRED_API_KEY = ""; //Not used anymore
  const SERIES_ID = "HSN1F";
  const FRED_OBS_URL = "https://fred-proxy.patrick-grow.workers.dev";

  // 2) Helpers
  const fmtNumber = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });
  const fmtPct = new Intl.NumberFormat("en-US", { maximumFractionDigits: 1, minimumFractionDigits: 1 });
  const fmtMonth = new Intl.DateTimeFormat("en-US", { year: "numeric", month: "short" });

  function parseFredValue(v) {
    if (v === "." || v === null || v === undefined) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function mean(nums) {
    const clean = nums.filter(n => n !== null && n !== undefined);
    if (clean.length === 0) return null;
    const s = clean.reduce((a, b) => a + b, 0);
    return s / clean.length;
  }

  function pctChange(curr, prev) {
    if (curr === null || prev === null) return null;
    if (prev === 0) return null;
    return (curr / prev - 1) * 100;
  }

  function addYears(dateObj, years) {
    const d = new Date(dateObj);
    d.setFullYear(d.getFullYear() + years);
    return d;
  }

  // 3) Fetch + transform
  async function fetchObservations() {
    const url = new URL(FRED_OBS_URL);
    url.searchParams.set("series_id", SERIES_ID);
    //url.searchParams.set("api_key", FRED_API_KEY);
    url.searchParams.set("file_type", "json");

    const resp = await fetch(url.toString());
    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error("FRED request failed (" + resp.status + "). Response:\n" + txt);
    }

    const data = await resp.json();
    if (!data || !Array.isArray(data.observations)) {
      throw new Error("Unexpected FRED response shape.");
    }

    const obs = data.observations
      .map(o => ({ date: new Date(o.date + "T00:00:00"), value: parseFredValue(o.value) }))
      .filter(o => o.value !== null)
      .sort((a, b) => a.date - b.date);

    if (obs.length === 0) throw new Error("No observations returned (after filtering missing values).");
    return obs;
  }

  function computeTableRows(obs) {
    const rows = obs.map((o, i) => {
      const yoy = (i >= 12) ? pctChange(o.value, obs[i - 12].value) : null;

      const currQ = (i >= 2) ? mean([obs[i].value, obs[i - 1].value, obs[i - 2].value]) : null;
      const prevQ = (i >= 5) ? mean([obs[i - 3].value, obs[i - 4].value, obs[i - 5].value]) : null;
      const qoq = (currQ !== null && prevQ !== null) ? pctChange(currQ, prevQ) : null;

      return { date: o.date, value: o.value, yoy: yoy, qoq: qoq };
    });

    return rows.slice(-18).reverse(); // newest first
  }

  function sliceLast20Years(obs) {
    const latest = obs[obs.length - 1].date;
    const start = addYears(latest, -20);
    return obs.filter(o => o.date >= start);
  }

  // 4) Render chart + table
  function renderChart(obs20y) {
    const labels = obs20y.map(o => fmtMonth.format(o.date));
    const values = obs20y.map(o => o.value);

    const ctx = document.getElementById("chart");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "HSN1F (Thousands, SAAR)",
          data: values,
          tension: 0.15,
          pointRadius: 0,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { ticks: { maxTicksLimit: 12 } },
          y: { ticks: { callback: (v) => fmtNumber.format(v) } }
        }
      }
    });
  }

  function renderTable(rows18) {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    for (const r of rows18) {
      const tr = document.createElement("tr");

      const monthTd = document.createElement("td");
      monthTd.textContent = fmtMonth.format(r.date);

      const valTd = document.createElement("td");
      valTd.textContent = fmtNumber.format(r.value);

      const yoyTd = document.createElement("td");
      yoyTd.textContent = (r.yoy === null) ? "-" : (fmtPct.format(r.yoy) + "%");

      const qoqTd = document.createElement("td");
      qoqTd.textContent = (r.qoq === null) ? "-" : (fmtPct.format(r.qoq) + "%");

      tr.appendChild(monthTd);
      tr.appendChild(valTd);
      tr.appendChild(yoyTd);
      tr.appendChild(qoqTd);

      tbody.appendChild(tr);
    }
  }

  // 5) Main
  (async function main() {
    const status = document.getElementById("status");
    const err = document.getElementById("err");

    try {
      status.textContent = "Fetching HSN1F from FRED...";
      err.textContent = "";

      const obs = await fetchObservations();
      const latest = obs[obs.length - 1].date;

      status.innerHTML = "<span class='ok'>Loaded</span> " + obs.length + " observations. Latest: " + fmtMonth.format(latest) + ".";

      renderChart(sliceLast20Years(obs));
      renderTable(computeTableRows(obs));

    } catch (e) {
      status.textContent = "Could not load data.";
      err.textContent = String(e && e.message ? e.message : e);
      console.error(e);
    }
  })();
</script>

</body>
</html>
